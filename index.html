<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { text-align:center; font-family:Arial; }
    input { width:60px; text-align:center; }
    button { margin:5px; padding:6px 12px; }
    .role-good { color:blue; font-weight:bold; }
    .role-bad { color:red; font-weight:bold; }
  </style>
</head>
<body>
  <h1>ğŸº ç‹¼äººæ®º - ä¸»æŒäººé </h1>
  <p id="phase">ç›®å‰éšæ®µï¼šæœªé–‹å§‹</p>

  <!-- å»ºç«‹éŠæˆ²å€ -->
  <div>
    ç©å®¶äººæ•¸ï¼š<input id="count" type="number" value="8" min="4">
    <button onclick="start()">é–‹å§‹éŠæˆ²</button>
  </div>

  <!-- å¤œæ™šæ“ä½œå€ -->
  <div style="margin-top:20px;">
    <h3>å¤œæ™šæ“ä½œ</h3>
    ç‹¼äººæ®ºäººç·¨è™Ÿï¼š
    <input type="number" id="wolf">
    <button onclick="wolf()">ç¢ºèª</button><br><br>

    å¥³å·«æ•‘äººç·¨è™Ÿï¼š
    <input type="number" id="save">
    <button onclick="save()">ç¢ºèª</button><br><br>

    å¥³å·«ä¸‹æ¯’ç·¨è™Ÿï¼š
    <input type="number" id="poison">
    <button onclick="poison()">ç¢ºèª</button><br><br>
  </div>

  <!-- ç™½å¤©æŠ•ç¥¨å€ -->
  <div style="margin-top:20px;">
    <h3>ç™½å¤©æŠ•ç¥¨ - é¸æ“‡è¦è™•æ±ºçš„ç©å®¶</h3>
    æŠ•ç¥¨ç©å®¶ç·¨è™Ÿï¼š
    <input type="number" id="vote">
    <button onclick="vote()">ç¢ºèªæŠ•ç¥¨</button>
  </div>

  <!-- ä¸»æŒäººè§’è‰²å€ -->
  <div style="margin-top:20px;">
    <h3>æ‰€æœ‰ç©å®¶è§’è‰²</h3>
    <div id="all-roles"></div>
  </div>

  <!-- å‹åˆ©æ–¹ -->
  <div style="margin-top:20px;">
    <h3>ğŸ† å‹åˆ©æ–¹ï¼š</h3>
    <div id="winner"></div>
  </div>

  <script>
    let gameId = 0;
    let phase = "night"; // åˆå§‹å¤œæ™š
    let gameOver = false;

    function start(){
      const count = Number(document.getElementById("count").value);
      if(count < 4){ alert("è‡³å°‘4äººæ‰èƒ½é–‹å§‹éŠæˆ²"); return; }

      google.script.run.withSuccessHandler(id=>{
        gameId = id;
        phase = "night";
        gameOver = false;
        updatePhase();
        showAllRoles();
        checkWinner();
      }).createGame(count);
    }

    function updatePhase(){
      document.getElementById("phase").innerText = "ç›®å‰éšæ®µï¼š" + (phase==="night"?"ğŸŒ™ å¤œæ™š":"â˜€ï¸ ç™½å¤©");
    }

    function switchPhase(){
      if(gameOver) return;
      phase = (phase==="night")?"day":"night";
      updatePhase();
      showAllRoles();
    }

    function showAllRoles(){
      if(!gameId) return;
      google.script.run.withSuccessHandler(game=>{
        const container = document.getElementById("all-roles");
        container.innerHTML = "";
        game.players.forEach(p=>{
          const roleClass = p.role==="ç‹¼äºº"?"role-bad":"role-good";
          container.innerHTML += `ç©å®¶ ${p.id}: <span class="${roleClass}">${p.role}</span> (${p.alive?"å­˜æ´»":"æ­»äº¡"})<br>`;
        });
      }).getGame(gameId);
    }

    function checkWinner(){
      if(!gameId) return;
      google.script.run.withSuccessHandler(winner=>{
        if(winner){
          document.getElementById("winner").innerHTML = `<b>${winner}</b>`;
          gameOver = true;
        } else {
          setTimeout(checkWinner,2000); // æ¯2ç§’æª¢æŸ¥ä¸€æ¬¡
        }
      }).checkWinner(gameId);
    }

    // ---------------- å¤œæ™šæ“ä½œ ----------------
    function wolf(){
      if(gameOver) return;
      const target = Number(document.getElementById("wolf").value);
      if(!target){alert("è«‹è¼¸å…¥ç·¨è™Ÿ"); return;}
      google.script.run.wolfKill(gameId,target);
      alert("ç‹¼äººæ®ºäººå®Œæˆ");
      showAllRoles();
      switchPhase();
    }

    function save(){
      if(gameOver) return;
      const target = Number(document.getElementById("save").value);
      if(!target){alert("è«‹è¼¸å…¥ç·¨è™Ÿ"); return;}
      google.script.run.witchSave(gameId,target);
      alert("å¥³å·«æ•‘äººå®Œæˆ");
      showAllRoles();
    }

    function poison(){
      if(gameOver) return;
      const target = Number(document.getElementById("poison").value);
      if(!target){alert("è«‹è¼¸å…¥ç·¨è™Ÿ"); return;}
      google.script.run.witchPoison(gameId,target);
      alert("å¥³å·«ä¸‹æ¯’å®Œæˆ");
      showAllRoles();
    }

    // ---------------- ç™½å¤©æŠ•ç¥¨ ----------------
    function vote(){
      if(gameOver) return;
      const target = Number(document.getElementById("vote").value);
      if(!target){alert("è«‹è¼¸å…¥ç·¨è™Ÿ"); return;}
      google.script.run.wolfKill(gameId,target);
      alert("æŠ•ç¥¨çµæŸï¼Œç©å®¶ "+target+" è¢«è™•æ±º");
      showAllRoles();
      switchPhase();
    }
  </script>
</body>
</html>
